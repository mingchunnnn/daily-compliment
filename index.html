<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>每日讚美收穫所</title>
  <meta name="google" content="notranslate">
  <style>
    :root{
      --ink:#1f2430;
      --muted:#4b5563;

      --line:#ffffffa8;
      --shadow: 0 22px 60px rgba(10,16,28,.18);
      --shadow2: 0 14px 34px rgba(10,16,28,.14);
      --radius: 22px;

      --g1:#ffd6ea; /* pearl pink */
      --g2:#c7f0ff; /* sea blue */
      --g3:#cdbdff; /* lilac */
      --g4:#bfffe7; /* mint */
      --g5:#ffe9c7; /* champagne */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--ink);
      overflow-x:hidden;

      background:
        radial-gradient(900px 520px at 12% 8%, rgba(255,214,234,.92) 0%, rgba(255,214,234,0) 60%),
        radial-gradient(820px 520px at 88% 14%, rgba(199,240,255,.92) 0%, rgba(199,240,255,0) 60%),
        radial-gradient(900px 560px at 52% 92%, rgba(205,189,255,.85) 0%, rgba(205,189,255,0) 62%),
        radial-gradient(720px 520px at 70% 70%, rgba(191,255,231,.55) 0%, rgba(191,255,231,0) 70%),
        linear-gradient(135deg, #fff2f8 0%, #e9fbff 35%, #f5efff 70%, #fff6ea 100%);
    }

    .sheen{
      position:fixed; inset:-10vh -10vw;
      pointer-events:none;
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(255,214,234,.18),
          rgba(199,240,255,.18),
          rgba(205,189,255,.18),
          rgba(191,255,231,.18),
          rgba(255,233,199,.18),
          rgba(255,214,234,.18));
      filter: blur(22px);
      opacity:.7;
      animation: sheen 18s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    @keyframes sheen{
      0%{ transform: translate3d(-2%, -1%, 0) rotate(0deg) scale(1.05); }
      50%{ transform: translate3d(2%, 1%, 0) rotate(18deg) scale(1.1); }
      100%{ transform: translate3d(-2%, -1%, 0) rotate(0deg) scale(1.05); }
    }

    .sparkle{ position:fixed; inset:-20vh -10vw; pointer-events:none; opacity:.95; }
    .dot{
      position:absolute;
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 62%);
      opacity:.35;
      animation: floaty linear infinite;
    }
    .bubble{
      position:absolute;
      width:14px; height:14px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.55);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 65%);
      box-shadow: 0 12px 24px rgba(10,16,28,.08);
      opacity:.22;
      animation: bubbleUp linear infinite;
    }
    @keyframes floaty{
      from{ transform: translate3d(var(--x0), var(--y0), 0) scale(var(--s)); }
      to  { transform: translate3d(var(--x1), var(--y1), 0) scale(var(--s)); }
    }
    @keyframes bubbleUp{
      from{ transform: translate3d(var(--x0), var(--y0), 0) scale(var(--s)); opacity:.12; }
      20%{opacity:.26}
      to  { transform: translate3d(var(--x1), var(--y1), 0) scale(var(--s)); opacity:0; }
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px 16px calc(24px + env(safe-area-inset-bottom));
    }

    /* Wider on desktop */
    .shell{
      width:min(980px, 100%);
    }

    .phone{
      border-radius: 30px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.28));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
    }
    .phone::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(240px 160px at 18% 12%, rgba(255,214,234,.35), transparent 70%),
        radial-gradient(240px 160px at 82% 18%, rgba(199,240,255,.35), transparent 70%),
        radial-gradient(260px 200px at 60% 86%, rgba(205,189,255,.28), transparent 72%);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:relative;
      padding: 14px 12px 6px;
      display:flex; gap:10px;
      align-items:flex-start; justify-content:space-between;
      z-index:1;
    }
    .title{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    h1{ margin:0; font-size: 18px; letter-spacing:.5px; font-weight: 820; }
    .sub{ margin:0; font-size: 12px; color: var(--muted); line-height:1.25; }

    .topright{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
      border:1px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 22px rgba(10,16,28,.08);
      white-space:nowrap;
    }
    .iconbtn{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.85);
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
      box-shadow: 0 12px 22px rgba(10,16,28,.10);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease;
    }
    .iconbtn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.05); }
    .iconbtn span{ font-size: 16px; }

    .card{
      position:relative;
      margin-top: 12px;
      padding: 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.38));
      border: 1px solid rgba(255,255,255,.88);
      box-shadow: var(--shadow2);
      z-index:1;
    }

    /* Desktop: 2 columns */
    .grid{
      display:block;
    }
    @media (min-width: 860px){
      .grid{
        display:grid;
        grid-template-columns: 1.05fr .95fr;
        gap: 14px;
        align-items: start;
      }
      .card{ margin-top: 14px; }
    }

    .hint{
      margin: 2px 0 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint b{ color:#273149; }

    .deck{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 8px;
    }

    .flip{ perspective: 950px; height: 126px; }
    .flip button{
      width:100%; height:100%;
      padding:0; border:0;
      border-radius: 18px;
      background: transparent;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .flip-inner{
      position:relative;
      width:100%; height:100%;
      transform-style: preserve-3d;
      transition: transform 520ms cubic-bezier(.2,.8,.2,1);
      border-radius: 18px;
    }
    .flip.is-flipped .flip-inner{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      border-radius: 18px;
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden; 
      transform: translateZ(0);           
      -webkit-transform: translateZ(0);
      border: 1px solid rgba(255,255,255,.9);
      box-shadow: 0 14px 26px rgba(10,16,28,.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
      user-select:none;
    }
    .wrapfront, .seal, .txt, .backIcon{
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

    .front{
      background:
        radial-gradient(140px 90px at 28% 20%, rgba(255,255,255,.95), rgba(255,255,255,0) 62%),
        linear-gradient(135deg, rgba(255,255,255,.9) 0%,
          rgba(255,214,234,.55) 30%,
          rgba(199,240,255,.55) 65%,
          rgba(205,189,255,.45) 100%);
      position:relative;
    }
    .front::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.45), transparent 55%);
      transform: rotate(18deg);
      opacity:.55;
      pointer-events:none;
    }
    .wrapfront{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .seal{
      width: 58px; height:58px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.62));
      border: 1px solid rgba(255,255,255,.92);
      display:flex; align-items:center; justify-content:center;
      font-size: 22px;
      box-shadow: 0 12px 22px rgba(10,16,28,.08);
    }
    .txt{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(39,49,73,.82);
      line-height: 1.2;
    }

    /* Back side: ONLY icon, no text */
    .back{
      transform: rotateY(180deg);
      background:
        radial-gradient(180px 110px at 70% 25%, rgba(255,255,255,.95), rgba(255,255,255,0) 64%),
        linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
    }
    .backIcon{
      width: 74px; height: 74px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.62));
      box-shadow: 0 14px 26px rgba(10,16,28,.10);
      display:flex; align-items:center; justify-content:center;
      font-size: 28px;
      color:#273149;
      position:relative;
      overflow:hidden;
    }
    .backIcon::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 58%);
      transform: rotate(12deg);
      opacity:.9;
    }

    .resultCard{
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.88);
      background: linear-gradient(180deg, rgba(255,255,255,.66), rgba(255,255,255,.34));
      box-shadow: 0 14px 34px rgba(10,16,28,.10);
      display:none;
    }
    .resultCard.show{ display:block; }

    .compliment{
      margin: 0;
      font-size: 17px;
      line-height: 1.3;
      letter-spacing: .3px;
      color: #21283a;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .ribbon{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(255,255,255,.60), rgba(255,255,255,.30));
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
    }
    .luck{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .luck .label{ font-size:12px; color: var(--muted); }
    .luck .value{
      font-size:14px; font-weight:840;
      letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:#273149;
    }
    .swatch{
      width: 46px; height: 46px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(10,16,28,.10);
      background: #b8a7b6;
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .swatch::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.55), transparent 55%);
      transform: rotate(18deg);
      opacity:.9;
    }

    .meta{
      margin-top: 10px;
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding: 13px 14px;
      font-size: 14px;
      font-weight: 780;
      letter-spacing: .4px;
      color: #23304a;
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 1px solid rgba(255,255,255,.92);
      box-shadow: 0 14px 30px rgba(10,16,28,.12);
      transition: transform .08s ease, filter .12s ease;
      flex: 1 1 160px;
      min-width: 150px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .footer{
      padding: 12px 4px 2px;
      display:flex; gap:10px;
      justify-content:space-between; align-items:center;
      color: var(--muted);
      font-size: 12px;
      position:relative;
      z-index:1;
    }
    .tiny{ opacity:.9; }
    a{ color: inherit; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,.85); }

    .heart{
      position:fixed;
      width: 12px; height: 12px;
      transform: rotate(45deg);
      background: rgba(255,255,255,.85);
      border-radius: 3px;
      pointer-events:none;
      filter: drop-shadow(0 8px 14px rgba(10,16,28,.18));
      animation: pop 900ms ease-out forwards;
      mix-blend-mode: screen;
    }
    .heart::before,.heart::after{
      content:"";
      position:absolute;
      width: 12px; height: 12px;
      background: inherit;
      border-radius: 999px;
      top:-6px; left:0;
    }
    .heart::after{ left:-6px; top:0; }
    @keyframes pop{
      0%{ opacity:0; transform: translate3d(0,0,0) rotate(45deg) scale(.6); }
      10%{ opacity:1; }
      100%{ opacity:0; transform: translate3d(var(--dx), var(--dy), 0) rotate(45deg) scale(1.35); }
    }

    @media (max-width: 360px){
      .deck{ gap:10px; }
      .flip{ height: 114px; }
      .btn{ min-width: 140px; }
    }
    /* ===== 上下裝飾：海洋夢幻 + 星光童話 + 柔和浪漫 ===== */
.top-decor, .bottom-decor{
  position: fixed;
  left: 0; right: 0;
  pointer-events: none;
  z-index: 0; /* 在內容下面，但在 body 背景上面 */
  mix-blend-mode: screen;
  opacity: .95;
}

/* 上方：水波光暈 + 淡淡星光 */
.top-decor{
  top: 0;
  height: 210px;
  background:
    radial-gradient(420px 210px at 20% 20%, rgba(255,214,234,.55), rgba(255,214,234,0) 70%),
    radial-gradient(520px 240px at 80% 10%, rgba(199,240,255,.55), rgba(199,240,255,0) 72%),
    radial-gradient(620px 300px at 55% 30%, rgba(205,189,255,.35), rgba(205,189,255,0) 72%),
    linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0));
  filter: blur(0px);
}

/* 用 SVG 水波（不用另外放檔案） */
.top-decor::after{
  content:"";
  position:absolute; inset:-30px -40px auto -40px;
  height: 260px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='260' viewBox='0 0 1200 260'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(255,255,255,0.55)'/%3E%3Cstop offset='1' stop-color='rgba(255,255,255,0)'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M0 120 C 160 80, 300 160, 480 120 C 660 80, 820 160, 1000 120 C 1080 100, 1140 92, 1200 110 L1200 0 L0 0 Z' fill='url(%23g)'/%3E%3Cpath d='M0 170 C 180 140, 320 220, 520 170 C 700 120, 860 220, 1040 170 C 1120 150, 1160 145, 1200 155 L1200 0 L0 0 Z' fill='rgba(255,255,255,0.22)'/%3E%3C/svg%3E");
  background-repeat: repeat-x;
  background-size: 1200px 260px;
  opacity: .55;
  filter: blur(1px);
  transform: translate3d(0,0,0);
  animation: waveMove 14s ease-in-out infinite;
}

@keyframes waveMove{
  0%{ background-position: 0 0; transform: translateY(0px); }
  50%{ background-position: -260px 0; transform: translateY(6px); }
  100%{ background-position: 0 0; transform: translateY(0px); }
}

/* 星光：少量、微閃、不干擾 */
.top-decor::before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(2px 2px at 14% 40%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
    radial-gradient(2px 2px at 28% 22%, rgba(255,255,255,.75), rgba(255,255,255,0) 60%),
    radial-gradient(2px 2px at 47% 35%, rgba(255,255,255,.80), rgba(255,255,255,0) 60%),
    radial-gradient(2px 2px at 68% 24%, rgba(255,255,255,.80), rgba(255,255,255,0) 60%),
    radial-gradient(2px 2px at 82% 46%, rgba(255,255,255,.75), rgba(255,255,255,0) 60%),
    radial-gradient(3px 3px at 91% 18%, rgba(255,255,255,.70), rgba(255,255,255,0) 60%);
  opacity: .55;
  filter: blur(.2px);
  animation: twinkle 3.6s ease-in-out infinite;
}

@keyframes twinkle{
  0%,100%{ opacity:.38; transform: translateY(0px); }
  50%{ opacity:.62; transform: translateY(1px); }
}

/* 下方：柔光弧形收尾（浪漫、不留白） */
.bottom-decor{
  bottom: 0;
  height: 230px;
  background:
    radial-gradient(520px 260px at 20% 90%, rgba(191,255,231,.48), rgba(191,255,231,0) 70%),
    radial-gradient(520px 260px at 80% 92%, rgba(255,214,234,.48), rgba(255,214,234,0) 72%),
    radial-gradient(720px 320px at 50% 105%, rgba(205,189,255,.42), rgba(205,189,255,0) 72%),
    linear-gradient(0deg, rgba(255,255,255,.26), rgba(255,255,255,0));
}

.bottom-decor::after{
  content:"";
  position:absolute; inset:auto -30px -40px -30px;
  height: 220px;
  border-radius: 999px 999px 0 0;
  background: radial-gradient(closest-side at 50% 110%, rgba(255,255,255,.55), rgba(255,255,255,0) 70%);
  opacity:.55;
  filter: blur(2px);
}

/* 確保內容層在裝飾之上 */
.wrap, .phone, header, .card, .footer{
  position: relative;
  z-index: 1;
}
    .card{
  padding: 30px;              
}
@media (min-width: 860px){
  .phone{ padding: 18px; }
  .card{ padding: 20px; }
}
    .bottom-mantra{
  position: fixed;
  left: 50%;
  bottom: calc(10px + env(safe-area-inset-bottom));
  transform: translateX(-50%);
  z-index: 5;
  pointer-events: none; /* 不擋你點卡片 */
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.55);
  background: linear-gradient(135deg, rgba(255,255,255,.30), rgba(255,255,255,.14));
  backdrop-filter: blur(10px);
  box-shadow: 0 16px 40px rgba(10,16,28,.16);
  max-width: min(92vw, 720px);
  text-align: center;
}
.mantra-text{
  font-size: 12px;
  letter-spacing: .6px;
  color: rgba(33,40,58,.72); /* 半透明字色 */
  text-shadow: 0 8px 20px rgba(10,16,28,.10);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
@media (min-width: 860px){
  .mantra-text{ font-size: 13px; }
}
    @media (min-width: 860px){
  .compliment{
    font-size: 22px;
  }
}
  </style>
</head>
<body>
  <body>
  <div class="sheen"></div>

  <!-- ✅ 新增：上方裝飾 -->
  <div class="top-decor" aria-hidden="true"></div>

  <div class="sparkle" id="sparkle"></div>

  <!-- ✅ 新增：下方裝飾 -->
  <div class="bottom-decor" aria-hidden="true"></div>

  <div class="wrap">
    
    <div class="shell">
      <main class="phone" role="main">
        <header>
          <div class="title">
            <h1>收穫你的今日讚美吧！</h1>
            <p class="sub">翻一張浪漫卡，讚美與幸運色會立刻出現 ✧</p>
          </div>

          <div class="topright">
            <div class="pill" id="todayPill">今天</div>
          </div>
        </header>

        <section class="card" aria-live="polite">
          <div class="grid">
            <!-- LEFT: cards -->
            <div>
              <div class="hint">
                <span>請翻一張卡：<b>愛意 / 光芒 / 安心</b></span>
                <span id="stateHint">尚未翻牌</span>
              </div>

              <div class="deck">
                <div class="flip" data-kind="愛意">
                  <button type="button" aria-label="翻牌：愛意">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">♡</div>
                          <div class="txt">點我翻開<br/>愛意卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">♡</div>
                      </div>
                    </div>
                  </button>
                </div>

                <div class="flip" data-kind="光芒">
                  <button type="button" aria-label="翻牌：光芒">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">✦</div>
                          <div class="txt">點我翻開<br/>光芒卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">✦</div>
                      </div>
                    </div>
                  </button>
                </div>

                <div class="flip" data-kind="安心">
                  <button type="button" aria-label="翻牌：安心">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">☁︎</div>
                          <div class="txt">點我翻開<br/>安心卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">☁︎</div>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- RIGHT: result -->
            <div class="resultCard" id="resultCard">
              <p class="compliment" id="compliment">（翻牌後出現。）</p>

              <div class="ribbon">
                <div class="luck">
                  <div class="label">今日浪漫幸運色</div>
                  <div class="value" id="luckyText">—</div>
                </div>
                <div class="swatch" id="swatch"></div>
              </div>

              <div class="meta">
                <span id="tag">#等你翻牌</span>
                <span id="streak">連續收穫：0 天</span>
              </div>

              <div class="actions">
                <button class="btn" id="btnCopy" disabled>複製（含幸運色）</button>
                <button class="btn" id="btnReset">重置今天</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
<div class="bottom-mantra" id="bottomMantra" aria-live="polite">
  <span class="mantra-text">你值得被溫柔對待，也值得被真心喜歡。</span>
</div>
<script>
  // 每個裝置/瀏覽器專屬 ID：第一次進來生成，之後固定存在 localStorage
const USER_ID_KEY = "daily-user-id-v1";
function getUserId(){
  let id = localStorage.getItem(USER_ID_KEY);
  if(!id){
    // 隨機、夠用且不會撞的 ID
    id = (crypto?.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2)));
    localStorage.setItem(USER_ID_KEY, id);
  }
  return id;
}
  const $ = (s) => document.querySelector(s);

  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };
  const niceDate = () => {
    const d = new Date();
    return d.toLocaleDateString('zh-TW', { month:'long', day:'numeric', weekday:'short' });
  };
  const hash32 = (str) => {
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  };
  const pick = (arr, seed) => arr[ seed % arr.length ];

  // Particles
  (function buildParticles(){
    const root = document.getElementById('sparkle');
    const w = window.innerWidth, h = window.innerHeight;

    for(let i=0;i<22;i++){
      const dot = document.createElement('div');
      dot.className = 'dot';
      const size = 6 + Math.random()*14;
      dot.style.width = dot.style.height = size + 'px';
      dot.style.left = (Math.random()*110 - 5) + 'vw';
      dot.style.top  = (Math.random()*120 - 10) + 'vh';
      dot.style.opacity = (0.16 + Math.random()*0.24).toFixed(2);
      const s = 0.6 + Math.random()*1.6;
      dot.style.setProperty('--s', s.toFixed(2));
      dot.style.setProperty('--x0', (Math.random()*w) + 'px');
      dot.style.setProperty('--y0', (Math.random()*h) + 'px');
      dot.style.setProperty('--x1', (Math.random()*w) + 'px');
      dot.style.setProperty('--y1', (-140 - Math.random()*h) + 'px');
      dot.style.animationDuration = (18 + Math.random()*18).toFixed(1) + 's';
      dot.style.animationDelay = (-Math.random()*18).toFixed(1) + 's';
      root.appendChild(dot);
    }

    for(let i=0;i<18;i++){
      const b = document.createElement('div');
      b.className = 'bubble';
      const size = 10 + Math.random()*26;
      b.style.width = b.style.height = size + 'px';
      b.style.left = (Math.random()*110 - 5) + 'vw';
      b.style.top  = (60 + Math.random()*70) + 'vh';
      const s = 0.6 + Math.random()*1.5;
      b.style.setProperty('--s', s.toFixed(2));
      b.style.setProperty('--x0', (Math.random()*w) + 'px');
      b.style.setProperty('--y0', (h + 120 + Math.random()*200) + 'px');
      b.style.setProperty('--x1', (Math.random()*w) + 'px');
      b.style.setProperty('--y1', (-220 - Math.random()*h) + 'px');
      b.style.animationDuration = (16 + Math.random()*18).toFixed(1) + 's';
      b.style.animationDelay = (-Math.random()*16).toFixed(1) + 's';
      root.appendChild(b);
    }
  })();

  // Compliment engine
  // ====== 大量 + 三風格（無名字版） ======
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pickR(arr, r){
  return arr[Math.floor(r() * arr.length)];
}

// 三張卡不同語氣詞庫（可再繼續加，越加越不重複）
const BANK = {
  "愛意": {
    openers: [
      "我想把一句溫柔放到你手心：",
      "先讓我認真稱讚你一下：",
      "今天的你值得被好好對待，因為",
      "我很喜歡你身上那種不費力的可愛：",
      "偷偷說，"
    ],
    traits: [
      "溫柔","細膩","體貼","柔軟但有邊界","很會照顧人也懂得照顧自己",
      "懂得分寸","真誠","可愛得很有個性","心很乾淨","很有同理心",
      "不急著證明什麼的從容","越相處越耐看的魅力","讓人願意信任的穩"
    ],
    focus: [
      "你的笑容","你的眼神","你的語氣","你對人的方式","你做小事的認真",
      "你把自己慢慢照顧回來的樣子","你願意理解而不是評判的心"
    ],
    metaphors: [
      "像海面月光一樣柔和又明亮",
      "像剛剛好的擁抱，讓人放心",
      "像珍珠的光，不刺眼但很難忘",
      "像春天的風，輕卻很有力量",
      "像人魚的歌聲，溫柔得讓人想靠近"
    ],
    affirm: [
      "你不用多做什麼，就已經很討喜。",
      "你不是靠討好才可愛，你是本來就很可愛。",
      "你值得被溫柔對待，而且不需要先表現得完美。",
      "你讓人想好好珍惜，因為你很真。",
      "你很值得被喜歡——真的。"
    ],
    closers: [
      "今天也請你把自己放在心上。",
      "你已經很棒了，而且你會越來越好。",
      "如果你忘了自己的好，我希望你記得這句。",
      "你值得被世界溫柔地接住。"
    ],
    tags: ["#愛意正中","#溫柔但有光","#今天也要被喜歡","#可愛是天生的","#你值得"]
  },

  "光芒": {
    openers: [
      "我想認真講：",
      "今天請你收下這句高級稱讚：",
      "你身上的光很明顯，因為",
      "我欣賞你的一點是：",
      "我超想把這句話貼在你額頭上："
    ],
    traits: [
      "有想法","有品味","有野心但不浮躁","自信得剛剛好","很會把事情做漂亮",
      "清醒","有判斷力","有行動力","目標感很強","不張揚但很有氣場",
      "越看越驚喜的魅力","能把平凡變質感的能力","很會把自己撐住也撐出高度"
    ],
    focus: [
      "你一認真起來的氣場","你做事的節奏","你整理混亂的能力","你解決問題的方式",
      "你對美感的掌握","你把界線拿捏得很漂亮","你不卑不亢的態度"
    ],
    metaphors: [
      "像海底的星光一路亮到水面",
      "像燈塔的光，穩穩指引方向",
      "像舞台上的聚光燈，但你不用用力就站得住",
      "像鑽石折射的光，越轉越耀眼",
      "像童話裡的主角，走到哪裡都自帶氛圍"
    ],
    affirm: [
      "你不是一下就看懂的漂亮，你是越看越驚喜。",
      "你有那種『不必大聲也會被看見』的強。",
      "你做得到，因為你一直都在往前。",
      "你很有份量，不需要用力證明。",
      "你的存在本身就很加分。"
    ],
    closers: [
      "把這份光留著，今天你會用得到。",
      "別小看自己，你比你以為的更亮。",
      "你的路會越走越順，因為你真的有料。",
      "請你大方一點：你值得被稱讚。"
    ],
    tags: ["#光芒萬丈","#不張揚的耀眼","#質感派強者","#你真的很行","#今天請自信"]
  },

  "安心": {
    openers: [
      "讓我把一句安心送給你：",
      "如果今天有點累，先聽我說：",
      "你身上有一種讓人放鬆的力量：",
      "我很珍惜你的一點是：",
      "今天想對你說："
    ],
    traits: [
      "沉靜","溫暖","可靠","很會安撫人心","不慌不忙的穩",
      "把情緒放得很溫柔","願意理解自己也理解別人","很有安全感",
      "能把日子過成舒服的樣子","心裡有光但不吵","柔和但不委屈"
    ],
    focus: [
      "你說話的溫度","你讓人放下防備的感覺","你處理情緒的成熟",
      "你願意慢慢來的耐心","你把自己照顧好的能力","你不勉強別人的善意"
    ],
    metaphors: [
      "像海的深呼吸，慢慢把焦躁帶走",
      "像被子蓋上的那一下，突然就安心了",
      "像微光的小夜燈，不刺眼但一直在",
      "像潮汐的節奏，提醒人一切都會過去",
      "像童話裡的安全屋，讓人願意停靠"
    ],
    affirm: [
      "你讓人覺得可以放心做自己。",
      "你不是在撐，你是在好好活著——而且活得很漂亮。",
      "你已經做得很好了，真的。",
      "你不需要急，日子會跟上你的。",
      "你值得被好好照顧，也值得被理解。"
    ],
    closers: [
      "今天也請你對自己溫柔一點。",
      "把肩膀放下來一下，你很值得休息。",
      "你會越來越穩、越來越好。",
      "世界很吵，但你可以很安定。"
    ],
    tags: ["#安心落地","#被溫柔接住","#今天先不逞強","#你很可靠","#慢慢來也很美"]
  }
};

const TEMPLATES = [
  ({focus, trait, metaphor, affirm, close}) =>
    `${focus}真的很加分——那種${trait}不是裝出來的，${metaphor}。${affirm} ${close}`,
  ({focus, trait, metaphor, affirm, close}) =>
    `我很喜歡${focus}帶來的感覺：很${trait}，也很真。你就像${metaphor}。${affirm} ${close}`,
  ({focus, trait, metaphor, affirm, close}) =>
    `${focus}讓人不自覺想靠近一點；因為你很${trait}。${metaphor}。${affirm} ${close}`,
  ({focus, trait, metaphor, affirm, close}) =>
    `你最迷人的不是某一個點，而是你整個人的節奏：${trait}、舒服、剛剛好。${metaphor}。${affirm} ${close}`,
  ({focus, trait, metaphor, affirm, close}) =>
    `如果把你放進一個童話場景裡，你會是那個讓人安心/心動的光源：${focus}很${trait}，${metaphor}。${affirm} ${close}`
];

function buildCompliment(seed, kind){
  const r = mulberry32(seed);
  const bank = BANK[kind] || BANK["愛意"];

  const payload = {
    focus: pickR(bank.focus, r),
    trait: pickR(bank.traits, r),
    metaphor: pickR(bank.metaphors, r),
    affirm: pickR(bank.affirm, r),
    close: pickR(bank.closers, r),
  };

  const opener = pickR(bank.openers, r);
  const body = pickR(TEMPLATES, r)(payload);
  return `${opener}\n\n${body}`;
}

function pickTag(seed, kind){
  const r = mulberry32(seed ^ 0x9e3779b9);
  const bank = BANK[kind] || BANK["愛意"];
  return pickR(bank.tags, r);
}

  const mermaidColors = [
    {name:"珍珠粉", hex:"#ffd6ea"},
    {name:"海月藍", hex:"#c7f0ff"},
    {name:"人魚紫", hex:"#cdbdff"},
    {name:"泡泡薄荷", hex:"#bfffe7"},
    {name:"香檳珍珠", hex:"#ffe9c7"},
    {name:"霧霓虹粉", hex:"#ffb9d6"},
    {name:"珊瑚奶油", hex:"#ffd0c8"},
    {name:"海鹽薰衣草", hex:"#bfb7ff"},
    {name:"柔光青藍", hex:"#b8e6ff"},
    {name:"貝殼米", hex:"#f7e7d3"}
  ];
  function getLuckyColor(){
    const day = todayISO();
    const uid = getUserId();
    const seed = hash32("lucky::" + day + "::" + uid);
    return mermaidColors[seed % mermaidColors.length];
  }

  // Daily lock
  const KEY = "daily-compliment-mermaid-v2";
  const PICK = "daily-pick-kind-v3";
  const STREAK = "daily-streak-v1";
  const LASTDAY = "daily-lastday-v1";

  function getDaily(kind){
    const day = todayISO();
    const saved = JSON.parse(localStorage.getItem(KEY) || "null");
    if(saved && saved.day === day && saved.kind === kind && saved.text){
      return saved;
    }
    const uid = getUserId();
    const seed = hash32("compliment::" + day + "::" + kind + "::" + uid);
    const text = buildCompliment(seed, kind);
    const tag = pickTag(seed,kind);
    const payload = { day, kind, seed, text, tag };
    localStorage.setItem(KEY, JSON.stringify(payload));
    return payload;
  }

  function updateStreak(){
    const day = todayISO();
    const last = localStorage.getItem(LASTDAY);
    let streak = parseInt(localStorage.getItem(STREAK) || "0", 10);

    if(last === day){
      // already counted
    } else {
      if(last){
        const dLast = new Date(last + "T00:00:00");
        const dToday = new Date(day  + "T00:00:00");
        const diff = Math.round((dToday - dLast) / (24*3600*1000));
        streak = (diff === 1) ? (streak + 1) : 1;
      } else {
        streak = 1;
      }
      localStorage.setItem(STREAK, String(streak));
      localStorage.setItem(LASTDAY, day);
    }
    $("#streak").textContent = `連續收穫：${streak} 天`;
  }

  function burstHearts(x,y){
    const n = 12;
    for(let i=0;i<n;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      h.style.left = x + 'px';
      h.style.top  = y + 'px';
      h.style.setProperty('--dx', (Math.random()*170 - 85).toFixed(1) + 'px');
      h.style.setProperty('--dy', (-90 - Math.random()*170).toFixed(1) + 'px');
      h.style.opacity = (0.5 + Math.random()*0.5).toFixed(2);
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 950);
    }
  }

  // ===== WebAudio: Mermaid vibe =====
  let audioCtx = null;
  let ambientOn = false;
  let ambientNodes = null;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function now(){ return audioCtx.currentTime; }

  function makeReverbLikeGain(){
    // lightweight "space" by using a feedback delay + filter (cheap reverb-ish)
    const input = audioCtx.createGain();
    const delay = audioCtx.createDelay(1.2);
    delay.delayTime.value = 0.22;
    const feedback = audioCtx.createGain();
    feedback.gain.value = 0.35;
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 1800;

    input.connect(delay);
    delay.connect(lp);
    lp.connect(feedback);
    feedback.connect(delay);

    const wet = audioCtx.createGain();
    wet.gain.value = 0.35;
    lp.connect(wet);

    const out = audioCtx.createGain();
    out.gain.value = 0.22;

    input.connect(out); // dry
    wet.connect(out);   // wet
    return { input, out };
  }

  function playChime(type="pearl"){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();

    const t0 = now();
    const master = audioCtx.createGain();
    master.gain.setValueAtTime(0.0001, t0);
    master.gain.exponentialRampToValueAtTime(0.35, t0 + 0.02);
    master.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.4);

    const rev = makeReverbLikeGain();
    master.connect(rev.input);
    rev.out.connect(audioCtx.destination);

    // Crystal bell partials
    const freqs =
      type === "love"  ? [523.25, 659.25, 783.99] :
      type === "shine" ? [587.33, 740.00, 880.00] :
      type === "calm"  ? [493.88, 622.25, 740.00] :
                         [554.37, 698.46, 830.61];

    freqs.forEach((f, i)=>{
      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.setValueAtTime(f, t0);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.22/(i+1), t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.2);

      osc.connect(g);
      g.connect(master);

      osc.start(t0 + i*0.012);
      osc.stop(t0 + 1.25);
    });

    // Bubble pops (short filtered noise)
    for(let i=0;i<4;i++){
      const tt = t0 + 0.06 + i*0.09;
      const bufferSize = Math.floor(audioCtx.sampleRate * 0.08);
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let j=0;j<bufferSize;j++){
        data[j] = (Math.random()*2 - 1) * (1 - j/bufferSize);
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;

      const bp = audioCtx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(900 + Math.random()*700, tt);
      bp.Q.value = 6;

      const ng = audioCtx.createGain();
      ng.gain.setValueAtTime(0.0001, tt);
      ng.gain.exponentialRampToValueAtTime(0.10, tt + 0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, tt + 0.09);

      noise.connect(bp);
      bp.connect(ng);
      ng.connect(master);

      noise.start(tt);
      noise.stop(tt + 0.08);
    }
  }

  function startAmbient(){
  ensureAudio();
  if(audioCtx.state === "suspended") audioCtx.resume();
  if(ambientOn) return;

  const t0 = now();

  // master + your light reverb-ish (if you still have makeReverbLikeGain)
  const master = audioCtx.createGain();
  master.gain.setValueAtTime(0.0001, t0);
  master.gain.exponentialRampToValueAtTime(2.5, t0 + 1.2); // 總音量：想更大 0.26，想更小 0.18

  const rev = makeReverbLikeGain();
  master.connect(rev.input);
  rev.out.connect(audioCtx.destination);

  // subtle vibrato (J-pop / anime feel)
  const vibrato = audioCtx.createOscillator();
  vibrato.type = "sine";
  vibrato.frequency.value = 5.8;

  const vibGain = audioCtx.createGain();
  vibGain.gain.value = 9; // 顫音幅度：想更甜 11，想更穩 6
  vibrato.connect(vibGain);
  vibrato.start();

  const midiToHz = (m) => 440 * Math.pow(2, (m - 69)/12);

  // --- Instrument: Music-box lead (sine + tiny bell overtone) ---
  function playMusicBox(midi, at, dur=0.45, amp=0.095){
    const f = midiToHz(midi);

    // main
    const o1 = audioCtx.createOscillator();
    o1.type = "sine";
    o1.frequency.setValueAtTime(f, at);
    vibGain.connect(o1.frequency);

    // bell overtone (adds sparkle)
    const o2 = audioCtx.createOscillator();
    o2.type = "sine";
    o2.frequency.setValueAtTime(f * 2.01, at);
    vibGain.connect(o2.frequency);

    // gentle highpass to keep it crisp
    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.value = 220;

    // tiny bandpass "music box" color
    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.value = 1400;
    bp.Q.value = 7;

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(amp, at + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, at + dur);

    o1.connect(bp);
    o2.connect(bp);
    bp.connect(hp);
    hp.connect(g);
    g.connect(master);

    o1.start(at);
    o2.start(at);
    o1.stop(at + dur + 0.03);
    o2.stop(at + dur + 0.03);
  }

  // --- Instrument: Soft arpeggio (triangle, warm) ---
  function playArp(midi, at, dur=0.28, amp=0.05){
    const f = midiToHz(midi);
    const o = audioCtx.createOscillator();
    o.type = "triangle";
    o.frequency.setValueAtTime(f, at);

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 1200;

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(amp, at + 0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, at + dur);

    o.connect(lp);
    lp.connect(g);
    g.connect(master);

    o.start(at);
    o.stop(at + dur + 0.03);
  }

  // --- Instrument: Soft bass (sine, very gentle) ---
  function playBass(midi, at, dur=0.8, amp=0.045){
    const f = midiToHz(midi);
    const o = audioCtx.createOscillator();
    o.type = "sine";
    o.frequency.setValueAtTime(f, at);

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 280;

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(amp, at + 0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, at + dur);

    o.connect(lp);
    lp.connect(g);
    g.connect(master);

    o.start(at);
    o.stop(at + dur + 0.04);
  }

  // ===== Harmony (C -> Am -> F -> G) =====
  const chords = [
    { name:"C",  chord:[60,64,67], bass:48 }, // C E G
    { name:"Am", chord:[57,60,64], bass:45 }, // A C E
    { name:"F",  chord:[53,57,60], bass:41 }, // F A C
    { name:"G",  chord:[55,59,62], bass:43 }, // G B D
  ];
  const bar = 3.2;      // 每個和弦長度
  const step = bar/8;   // 8 分音符

  // ===== “華麗主旋律” (anime-ish / mermaid-fairytale) =====
  // 用分段（每個和弦 8 個音）串成一個長旋律，然後循環
  // 音域偏高，像主題曲
  const melodyByChord = {
    "C":  [76,79,81,79, 76,74,72,74],
    "Am": [76,79,83,81, 79,76,74,72],
    "F":  [74,77,81,79, 77,74,72,74],
    "G":  [74,79,83,81, 79,77,76,74],
  };

  // Arp patterns (supporting glitter)
  const arpByChord = {
    "C":  [60,64,67,72, 67,64,60,64],
    "Am": [57,60,64,69, 64,60,57,60],
    "F":  [53,57,60,65, 60,57,53,57],
    "G":  [55,59,62,67, 62,59,55,59],
  };

  // schedule for ~2 minutes
  const loops = 10;
  let cur = t0 + 0.15;

  for(let k=0;k<loops;k++){
    for(let i=0;i<chords.length;i++){
      const ch = chords[i];
      const name = ch.name;

      // bass at chord start
      playBass(ch.bass, cur + 0.00, 1.05, 0.05);

      // arpeggio across bar
      const arp = arpByChord[name];
      for(let n=0;n<8;n++){
        playArp(arp[n], cur + n*step + 0.02, 0.26, 0.05);
      }

      // main melody (music box)
      const mel = melodyByChord[name];
      for(let n=0;n<8;n++){
        // make some notes longer for "華麗" phrasing
        const long = (n === 2 || n === 6);
        playMusicBox(
          mel[n],
          cur + n*step + 0.01,
          long ? 0.55 : 0.42,
          long ? 0.115 : 0.095
        );
        // little sparkle octave on strong beats
        if(n === 0 || n === 4){
          playMusicBox(mel[n] + 12, cur + n*step + 0.03, 0.25, 0.055);
        }
      }

      cur += bar;
    }
  }

  ambientNodes = { master, vibrato };
  ambientOn = true;
}

  function stopAmbient(){
    if(!audioCtx || !ambientOn || !ambientNodes) return;

    const t0 = now();
    // graceful fade
    ambientNodes.out.gain.setTargetAtTime(0.0001, t0, 0.12);

    setTimeout(()=>{
      try{
        ambientNodes.noise.stop();
        ambientNodes.lfo.stop();
        ambientNodes.shimmer.stop();
        ambientNodes.shimmer2.stop();
      }catch(e){}
      ambientNodes = null;
      ambientOn = false;
    }, 650);
  }

  function toggleAmbient(){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();
    if(ambientOn) stopAmbient();
    else startAmbient();
  }

  // UI audio buttons
  

  // Init
  $("#todayPill").textContent = niceDate();
  $("#streak").textContent = `連續收穫：${parseInt(localStorage.getItem(STREAK)||"0",10)} 天`;

  let hasFlipped = false;

  function showResult(kind, clickX, clickY){
    const daily = getDaily(kind);
    const lucky = getLuckyColor();

    $("#compliment").textContent = daily.text;
    $("#tag").textContent = daily.tag;

    $("#luckyText").textContent = `${lucky.name}（${lucky.hex}）`;
    $("#swatch").style.background = lucky.hex;

    $("#resultCard").classList.add("show");
    $("#btnCopy").disabled = false;

    $("#stateHint").textContent = `你翻到「${kind}」— 已收穫今天的讚美 ✧`;
    updateStreak();
    burstHearts(clickX || (window.innerWidth/2), clickY || (window.innerHeight*0.48));

    // sound
    const tone = (kind === "愛意") ? "love" : (kind === "光芒") ? "shine" : "calm";
    playChime(tone);
    // optional: start ambient gently after first interaction
    if(!ambientOn) startAmbient();
  }

  // Flip logic
  document.querySelectorAll(".flip").forEach((el)=>{
    el.addEventListener("click", (ev)=>{
      if(hasFlipped) return;
      hasFlipped = true;

      const kind = el.getAttribute("data-kind");
      localStorage.setItem(PICK, kind);

      el.classList.add("is-flipped");
      setTimeout(()=>{
        showResult(kind, ev.clientX, ev.clientY);
      }, 320);
    });
  });

  // Copy
  $("#btnCopy").addEventListener("click", async ()=>{
    const kind = localStorage.getItem(PICK);
    if(!kind) return;
    const daily = getDaily(kind);
    const text = `${daily.text}\n\n${$("#luckyText").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      $("#tag").textContent = "#已複製（含幸運色）";
      playChime("pearl");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      $("#tag").textContent = "#已複製（含幸運色）";
      playChime("pearl");
    }
  });

  // Reset today
  $("#btnReset").addEventListener("click", ()=>{
    localStorage.removeItem(KEY);
    localStorage.removeItem(PICK);
    hasFlipped = false;

    $("#stateHint").textContent = "尚未翻牌";
    $("#resultCard").classList.remove("show");
    $("#btnCopy").disabled = true;
    $("#tag").textContent = "#等你翻牌";
    $("#compliment").textContent = "（翻牌後出現。）";

    document.querySelectorAll(".flip").forEach(el => el.classList.remove("is-flipped"));
    playChime("pearl");
  });
</script>
</body>
</html>
