<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>每日讚美收穫所</title>
  <style>
    :root{
      --bg1:#d9d3cf; --bg2:#c7c0bd; --bg3:#c9d2cf;
      --ink:#2f2f33; --muted:#5a5a62;
      --card:#f4f1efcc; --card2:#ffffffb5; --line:#ffffff80;
      --accent:#b8a7b6; --accent2:#a9b9b1; --accent3:#c3b49f;
      --shadow: 0 18px 40px rgba(20,20,30,.14);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--ink);
      overflow-x:hidden;
      background:
        radial-gradient(900px 500px at 15% 12%, #ffffff55 0%, transparent 55%),
        radial-gradient(900px 500px at 85% 18%, #ffffff40 0%, transparent 55%),
        radial-gradient(700px 500px at 50% 90%, #ffffff35 0%, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg3) 50%, var(--bg2));
    }

    /* dreamy floating sparkles */
    .sparkle{ position:fixed; inset:-20vh -10vw; pointer-events:none; opacity:.9; }
    .dot{
      position:absolute; width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #ffffffcc, #ffffff00 65%);
      opacity:.35; animation: floaty linear infinite;
    }
    @keyframes floaty{
      from{ transform: translate3d(var(--x0), var(--y0), 0) scale(var(--s)); }
      to  { transform: translate3d(var(--x1), var(--y1), 0) scale(var(--s)); }
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px 16px calc(24px + env(safe-area-inset-bottom));
    }
    .phone{
      width:min(440px, 100%);
      border-radius: 30px;
      padding: 16px;
      background: linear-gradient(180deg, #ffffff70, #ffffff25);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    header{
      padding: 14px 12px 6px;
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    h1{ margin:0; font-size: 18px; letter-spacing:.5px; font-weight: 760; }
    .sub{ margin:0; font-size: 12px; color: var(--muted); line-height:1.25; }
    .pill{
      flex:0 0 auto;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: linear-gradient(135deg, #ffffffaa, #ffffff55);
      border:1px solid #ffffff80;
      box-shadow: 0 10px 22px rgba(20,20,30,.08);
    }

    .card{
      margin-top: 12px;
      padding: 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid #ffffff90;
      box-shadow: 0 16px 34px rgba(20,20,30,.10);
    }

    /* --- Flip card mini game --- */
    .hint{
      margin: 2px 0 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint b{ color:#2b2b31; }
    .deck{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 8px;
    }
    .flip{
      perspective: 900px;
      height: 112px;
    }
    .flip button{
      width:100%;
      height:100%;
      padding:0;
      border-radius: 18px;
      border:0;
      background: transparent;
      box-shadow:none;
    }
    .flip-inner{
      position:relative;
      width:100%; height:100%;
      transform-style: preserve-3d;
      transition: transform 520ms cubic-bezier(.2,.8,.2,1);
      border-radius: 18px;
    }
    .flip.is-flipped .flip-inner{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      border-radius: 18px;
      backface-visibility:hidden;
      border: 1px solid #ffffffaa;
      box-shadow: 0 14px 26px rgba(20,20,30,.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
      user-select:none;
    }
    .front{
      background:
        radial-gradient(120px 90px at 30% 20%, #ffffffcc, #ffffff00 65%),
        linear-gradient(135deg, #ffffffcc, #f1e7f0 40%, #e8f0ee 100%);
    }
    .front .seal{
      width: 54px; height:54px;
      border-radius: 18px;
      background: linear-gradient(135deg, #ffffffcc, #ffffff66);
      border: 1px solid #ffffffaa;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 20px;
      box-shadow: 0 12px 22px rgba(20,20,30,.08);
    }
    .front .txt{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
    .front .wrapfront{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }

    .back{
      transform: rotateY(180deg);
      background:
        radial-gradient(140px 100px at 70% 25%, #ffffffcc, #ffffff00 68%),
        linear-gradient(135deg, #ffffffcc, #ffffff70);
    }
    .back .pick{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 760;
      letter-spacing:.3px;
      background: linear-gradient(135deg, #ffffffcc, #ffffff66);
      border: 1px solid #ffffffaa;
      box-shadow: 0 10px 18px rgba(20,20,30,.08);
      margin: 0 auto;
    }
    .badge.m1{ background: linear-gradient(135deg, #ffffffcc, #f1e7f0aa); }
    .badge.m2{ background: linear-gradient(135deg, #ffffffcc, #e8f0eeaa); }
    .badge.m3{ background: linear-gradient(135deg, #ffffffcc, #f3efe7aa); }

    .compliment{
      margin-top: 14px;
      font-size: 16px;
      line-height: 1.65;
      letter-spacing: .3px;
      color: #2b2b31;
      white-space: pre-wrap;
      word-break: break-word;
      display:none;
    }
    .compliment.show{ display:block; }

    .meta{
      margin-top: 10px;
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .actions{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: .4px;
      color: #2b2b31;
      background: linear-gradient(135deg, #ffffffcc, #ffffff70);
      border: 1px solid #ffffffaa;
      box-shadow: 0 14px 30px rgba(20,20,30,.12);
      transition: transform .08s ease, filter .12s ease;
      flex: 1 1 220px;
      min-width: 180px;
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.08); }
    .btn.primary{ background: linear-gradient(135deg, #fff 0%, #f1e7f0 35%, #e8f0ee 100%); }
    .btn.ghost{ background: linear-gradient(135deg, #ffffff80, #ffffff40); font-weight: 650; }

    .ribbon{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--radius);
      border:1px dashed #ffffffaa;
      background: linear-gradient(135deg, #ffffff66, #ffffff22);
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
    }
    .luck{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .luck .label{ font-size:12px; color: var(--muted); }
    .luck .value{
      font-size:14px; font-weight:760;
      letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .swatch{
      width: 44px; height: 44px;
      border-radius: 14px;
      border:1px solid #ffffffaa;
      box-shadow: 0 10px 22px rgba(20,20,30,.10);
      background: var(--accent);
      flex:0 0 auto;
    }

    .footer{
      padding: 12px 4px 2px;
      display:flex; gap:10px;
      justify-content:space-between; align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .tiny{ opacity:.85; }
    a{ color: inherit; text-decoration: none; border-bottom: 1px dashed #ffffffaa; }

    /* heart particles */
    .heart{
      position:fixed;
      width: 12px; height: 12px;
      transform: rotate(45deg);
      background: rgba(255,255,255,.8);
      border-radius: 3px;
      pointer-events:none;
      filter: drop-shadow(0 8px 14px rgba(20,20,30,.18));
      animation: pop 900ms ease-out forwards;
    }
    .heart::before,.heart::after{
      content:"";
      position:absolute;
      width: 12px; height: 12px;
      background: inherit;
      border-radius: 999px;
      top:-6px; left:0;
    }
    .heart::after{ left:-6px; top:0; }
    @keyframes pop{
      0%{ opacity:0; transform: translate3d(0,0,0) rotate(45deg) scale(.6); }
      10%{ opacity:1; }
      100%{ opacity:0; transform: translate3d(var(--dx), var(--dy), 0) rotate(45deg) scale(1.3); }
    }

    /* small responsive tweak */
    @media (max-width: 360px){
      .deck{ gap:10px; }
      .flip{ height: 104px; }
      .btn{ min-width: 160px; }
    }
  </style>
</head>
<body>
  <div class="sparkle" id="sparkle"></div>

  <div class="wrap">
    <main class="phone" role="main">
      <header>
        <div class="title">
          <h1>每日讚美收穫所</h1>
          <p class="sub">翻一張浪漫卡，才揭曉今天的讚美（同一天固定同一句）。</p>
        </div>
        <div class="pill" id="todayPill">今天</div>
      </header>

      <section class="card" aria-live="polite">
        <div class="hint">
          <span>請先翻一張卡：<b>愛意 / 光芒 / 安心</b></span>
          <span id="stateHint">尚未翻牌</span>
        </div>

        <div class="deck" id="deck">
          <!-- card 1 -->
          <div class="flip" data-kind="愛意">
            <button type="button" aria-label="翻牌：愛意">
              <div class="flip-inner">
                <div class="face front">
                  <div class="wrapfront">
                    <div class="seal">♡</div>
                    <div class="txt">點我翻開<br/>愛意卡</div>
                  </div>
                </div>
                <div class="face back">
                  <div class="pick">
                    <div class="badge m1">你翻到：愛意</div>
                    <div style="font-size:12px;color:var(--muted);line-height:1.25;">
                      今天的讚美會更偏「溫柔喜歡你」的語氣。
                    </div>
                  </div>
                </div>
              </div>
            </button>
          </div>

          <!-- card 2 -->
          <div class="flip" data-kind="光芒">
            <button type="button" aria-label="翻牌：光芒">
              <div class="flip-inner">
                <div class="face front">
                  <div class="wrapfront">
                    <div class="seal">✦</div>
                    <div class="txt">點我翻開<br/>光芒卡</div>
                  </div>
                </div>
                <div class="face back">
                  <div class="pick">
                    <div class="badge m2">你翻到：光芒</div>
                    <div style="font-size:12px;color:var(--muted);line-height:1.25;">
                      今天的讚美會更偏「你真的很有魅力」的語氣。
                    </div>
                  </div>
                </div>
              </div>
            </button>
          </div>

          <!-- card 3 -->
          <div class="flip" data-kind="安心">
            <button type="button" aria-label="翻牌：安心">
              <div class="flip-inner">
                <div class="face front">
                  <div class="wrapfront">
                    <div class="seal">☁︎</div>
                    <div class="txt">點我翻開<br/>安心卡</div>
                  </div>
                </div>
                <div class="face back">
                  <div class="pick">
                    <div class="badge m3">你翻到：安心</div>
                    <div style="font-size:12px;color:var(--muted);line-height:1.25;">
                      今天的讚美會更偏「你讓人放鬆、很值得被愛」的語氣。
                    </div>
                  </div>
                </div>
              </div>
            </button>
          </div>
        </div>

        <p class="compliment" id="compliment">
          （翻一張卡，我就把今天的讚美遞給你。）
        </p>

        <div class="meta">
          <span id="tag">#等你翻牌</span>
          <span id="streak">連續收穫：0 天</span>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnReveal" disabled>收穫今天的讚美吧</button>
          <button class="btn ghost" id="btnLucky">抽一個今日浪漫幸運色</button>
          <button class="btn ghost" id="btnCopy" disabled>把這句收藏到剪貼簿</button>
        </div>

        <div class="ribbon" id="luckyBox" style="display:none;">
          <div class="luck">
            <div class="label">今日浪漫幸運色</div>
            <div class="value" id="luckyText">—</div>
          </div>
          <div class="swatch" id="swatch"></div>
        </div>
      </section>

      <div class="footer">
        <span class="tiny">小提醒：想換卡面與語氣，可點右邊「重置今天」。</span>
        <span class="tiny"><a href="#" id="btnReset">重置今天</a></span>
      </div>
    </main>
  </div>

<script>
  const $ = (s) => document.querySelector(s);

  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };
  const niceDate = () => {
    const d = new Date();
    return d.toLocaleDateString('zh-TW', { month:'long', day:'numeric', weekday:'short' });
  };

  const hash32 = (str) => {
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  };
  const pick = (arr, seed) => arr[ seed % arr.length ];

  // Sparkles
  (function buildSparkles(){
    const root = document.getElementById('sparkle');
    const count = 26;
    const w = window.innerWidth, h = window.innerHeight;
    for(let i=0;i<count;i++){
      const dot = document.createElement('div');
      dot.className = 'dot';
      const size = 6 + Math.random()*14;
      dot.style.width = dot.style.height = size + 'px';
      dot.style.left = (Math.random()*110 - 5) + 'vw';
      dot.style.top  = (Math.random()*120 - 10) + 'vh';
      dot.style.opacity = (0.18 + Math.random()*0.25).toFixed(2);
      const s = 0.6 + Math.random()*1.4;
      dot.style.setProperty('--s', s.toFixed(2));
      dot.style.setProperty('--x0', (Math.random()*w) + 'px');
      dot.style.setProperty('--y0', (Math.random()*h) + 'px');
      dot.style.setProperty('--x1', (Math.random()*w) + 'px');
      dot.style.setProperty('--y1', (-120 - Math.random()*h) + 'px');
      dot.style.animationDuration = (18 + Math.random()*18).toFixed(1) + 's';
      dot.style.animationDelay = (-Math.random()*18).toFixed(1) + 's';
      root.appendChild(dot);
    }
  })();

  // Compliment vocab
  const vocab = {
    vibe: ["乾淨的氣質","溫柔但有底氣的氣場","很耐看的光","不張揚的耀眼","安靜的自信","舒服的存在感"],
    eyes: ["眼神","笑容","語氣","步伐","表情","說話的節奏"],
    quality: ["細膩","真誠","有分寸","有想法","有同理心","很可靠","很有品味","很會照顧人但不委屈自己"],
    effort: ["你願意把事情做好","你在疲憊時仍不敷衍","你把自己慢慢照顧回來","你願意學、願意改、也願意原諒自己","你把小事做得很漂亮"],
    charm: ["可愛得很有個性","漂亮得不需要大聲","迷人得很有層次","溫柔得很有邊界","閃亮得剛剛好"],
    metaphor: [
      "像莫蘭迪色的夕陽：不刺眼，卻讓人一直想多看一眼。",
      "像剛洗好的棉被：乾淨、柔軟，靠近就覺得安心。",
      "像夜裡的小燈：不轟轟烈烈，但足夠把路照亮。",
      "像春天的風：輕輕的，卻真的會改變人的心情。",
      "像一本耐讀的書：越了解越覺得你很有內容。"
    ],
    ending: [
      "所以今天也請你放心：你很值得被喜歡。",
      "我希望你把這句話收好，因為它是真的。",
      "你不用變成誰的版本，你就是很好看的那種人。",
      "世界很吵，但你是那種能讓人靜下來的存在。",
      "你已經做得很棒了，而且你還會更好。"
    ],
    tag: ["#氣質派讚美","#內在發光","#外在也很可以","#溫柔但堅定","#今天的你很迷人","#你值得被好好看見"]
  };

  const fullCompliments = [
    "你有一種很稀有的能力：把複雜的事情用溫柔講清楚，還不會讓人覺得被冒犯。",
    "你不是那種靠用力討好才可愛的人；你可愛得很自然，像呼吸一樣。",
    "你最迷人的地方不是外表的某一個點，而是你整個人散發的「好好生活」感。",
    "你有一種乾淨的漂亮：不需要很多裝飾，就已經很耐看、很舒服。",
    "你在意細節的方式很漂亮，不是控制，是把每件事都做得有質感。",
    "你看似溫柔，但你其實很有骨氣；這種反差特別讓人尊敬。",
    "你讓人覺得安心，不是因為你完美，而是你真誠、也願意好好面對。",
    "你把界線畫得剛剛好：既不冷漠，也不委屈自己，這真的很成熟。",
    "你有一種不急著證明什麼的自信，那種從容比任何標籤都更漂亮。",
    "你不是在「撐住」，你是在「往前走」——而且走得比你以為的更好看。"
  ];

  // Extra tone lines by card kind
  const toneLine = {
    "愛意": [
      "有人喜歡你不是因為你做了什麼，而是因為你本來就很討喜。",
      "你不必用力證明，你的可愛本來就站得住腳。",
      "你值得被溫柔地對待，而且是「不用先表現很好」也值得。"
    ],
    "光芒": [
      "你不是那種一下就看懂的漂亮，你是越看越驚喜的那種。",
      "你有一種把平凡變得很有質感的能力，這很難得。",
      "你一認真起來，整個人都有光，真的。"
    ],
    "安心": [
      "你讓人感到放鬆，像終於可以把肩膀放下來那樣。",
      "你說話的溫度很剛好：不冰，也不燙，剛好能被接住。",
      "你身上有種「會好起來」的氣息，靠近就覺得踏實。"
    ]
  };

  const templates = [
    (r)=>`你今天的${r.eyes}很有故事感，不需要解釋太多，就讓人想靠近一點、再靠近一點。${r.ending}`,
    (r)=>`你身上那種${r.vibe}很加分：不是高調的漂亮，而是會讓人記住的那種。${r.ending}`,
    (r)=>`我很喜歡你處理事情的方式——${r.quality}又不失溫度，這真的不是每個人都有。${r.ending}`,
    (r)=>`你知道嗎？${r.effort}的樣子特別好看，因為那代表你很認真地在愛自己的人生。${r.ending}`,
    (r)=>`你給人的感覺是${r.charm}，而且越相處越明顯。${r.metaphor} ${r.ending}`,
    (r)=>`如果把你放進一幅畫裡，你一定是那個最耐看的色塊：安靜、柔和，卻很有力量。${r.ending}`
  ];

  function buildCompliment(seed, kind){
    const r = {
      vibe: pick(vocab.vibe, seed+11),
      eyes: pick(vocab.eyes, seed+23),
      quality: pick(vocab.quality, seed+37),
      effort: pick(vocab.effort, seed+41),
      charm: pick(vocab.charm, seed+53),
      metaphor: pick(vocab.metaphor, seed+67),
      ending: pick(vocab.ending, seed+71)
    };

    // 30% full, 70% templated
    const useFull = (seed % 10) < 3;
    let base = useFull ? fullCompliments[seed % fullCompliments.length] : templates[seed % templates.length](r);

    // add tone line (kind-specific) to make it feel tailored
    const tone = pick(toneLine[kind] || toneLine["愛意"], seed+97);
    // lightly stitch
    return `${tone}\n\n${base}`;
  }

  function pickTag(seed){ return pick(vocab.tag, seed+101); }

  // Storage keys
  const KEY = "daily-compliment-v2";
  const PICK = "daily-pick-kind-v1";
  const STREAK = "daily-streak-v1";
  const LASTDAY = "daily-lastday-v1";
  const LUCKY = "daily-lucky-v1";

  function getDaily(kind){
    const day = todayISO();
    const saved = JSON.parse(localStorage.getItem(KEY) || "null");

    // same day + same kind => fixed
    if(saved && saved.day === day && saved.kind === kind && saved.text){
      return saved;
    }

    // If user picked a different kind today, we still keep "fixed per kind" for that day.
    // Seed includes day + kind.
    const seed = hash32("compliment::" + day + "::" + kind);
    const text = buildCompliment(seed, kind);
    const tag = pickTag(seed);

    const payload = { day, kind, seed, text, tag };
    localStorage.setItem(KEY, JSON.stringify(payload));
    return payload;
  }

  function updateStreak(){
    const day = todayISO();
    const last = localStorage.getItem(LASTDAY);
    let streak = parseInt(localStorage.getItem(STREAK) || "0", 10);

    if(last === day){
      // already counted today
    } else {
      if(last){
        const dLast = new Date(last + "T00:00:00");
        const dToday = new Date(day  + "T00:00:00");
        const diff = Math.round((dToday - dLast) / (24*3600*1000));
        if(diff === 1) streak += 1;
        else streak = 1;
      } else {
        streak = 1;
      }
      localStorage.setItem(STREAK, String(streak));
      localStorage.setItem(LASTDAY, day);
    }
    $("#streak").textContent = `連續收穫：${streak} 天`;
  }

  function render(daily){
    $("#compliment").textContent = daily.text;
    $("#tag").textContent = daily.tag;
    $("#compliment").classList.add("show");
    $("#btnCopy").disabled = false;
  }

  // Hearts
  function burstHearts(x,y){
    const n = 12;
    for(let i=0;i<n;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      h.style.left = x + 'px';
      h.style.top  = y + 'px';
      h.style.setProperty('--dx', (Math.random()*160 - 80).toFixed(1) + 'px');
      h.style.setProperty('--dy', (-80 - Math.random()*160).toFixed(1) + 'px');
      h.style.opacity = (0.5 + Math.random()*0.5).toFixed(2);
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 950);
    }
  }

  // Lucky color
  const morandiColors = [
    {name:"霧玫瑰", hex:"#c7a3b0"},
    {name:"灰紫藕", hex:"#b8a7b6"},
    {name:"灰豆綠", hex:"#a9b9b1"},
    {name:"奶茶砂", hex:"#c3b49f"},
    {name:"霧藍灰", hex:"#aab7c4"},
    {name:"杏桃霧", hex:"#d2b5a5"},
    {name:"雨雲灰", hex:"#b9b7b9"},
    {name:"淡鼠尾草", hex:"#b7c3bb"},
    {name:"玫瑰奶油", hex:"#d9c5cc"},
    {name:"燕麥米", hex:"#d7d0c3"}
  ];
  function getLuckyColor(){
    const day = todayISO();
    const saved = JSON.parse(localStorage.getItem(LUCKY) || "null");
    if(saved && saved.day === day) return saved;
    const seed = hash32("lucky::" + day);
    const c = morandiColors[seed % morandiColors.length];
    const payload = { day, ...c };
    localStorage.setItem(LUCKY, JSON.stringify(payload));
    return payload;
  }
  function showLucky(){
    const c = getLuckyColor();
    $("#luckyBox").style.display = "flex";
    $("#luckyText").textContent = `${c.name}（${c.hex}）`;
    $("#swatch").style.background = c.hex;
  }

  // Copy
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      $("#tag").textContent = "#已複製到剪貼簿";
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      $("#tag").textContent = "#已複製到剪貼簿";
    }
  }

  // Init
  $("#todayPill").textContent = niceDate();
  $("#streak").textContent = `連續收穫：${parseInt(localStorage.getItem(STREAK)||"0",10)} 天`;

  let pickedKind = localStorage.getItem(PICK) || ""; // 愛意/光芒/安心
  let hasFlipped = false;

  function setStateHint(text){ $("#stateHint").textContent = text; }

  // If already picked kind today and stored compliment exists, we still require flip for ritual,
  // but we can enable reveal after user flips any card (and it will lock to picked kind).
  if(pickedKind){
    setStateHint(`今日偏好：${pickedKind}（還沒翻牌）`);
  }

  // Flip logic (only first flip counts)
  document.querySelectorAll(".flip").forEach((el)=>{
    el.addEventListener("click", (ev)=>{
      if(hasFlipped) return;

      const kind = el.getAttribute("data-kind");
      hasFlipped = true;
      pickedKind = kind;
      localStorage.setItem(PICK, kind);

      // flip selected card
      el.classList.add("is-flipped");
      // add subtle flip on others (optional: keep front)
      setTimeout(()=>{
        setStateHint(`你翻到「${kind}」— 讚美已準備好`);
        $("#btnReveal").disabled = false;
        burstHearts(ev.clientX || (window.innerWidth/2), ev.clientY || (window.innerHeight*0.45));
      }, 280);
    });
  });

  // Reveal
  $("#btnReveal").addEventListener("click", (ev)=>{
    if(!pickedKind){
      setStateHint("先翻一張卡，才有儀式感唷");
      return;
    }
    const daily = getDaily(pickedKind);
    render(daily);
    updateStreak();
    $("#btnReveal").textContent = "再看一次今天的讚美";
    burstHearts(ev.clientX || (window.innerWidth/2), ev.clientY || (window.innerHeight*0.55));
  });

  $("#btnLucky").addEventListener("click", (ev)=>{
    showLucky();
    burstHearts(ev.clientX || (window.innerWidth/2), ev.clientY || (window.innerHeight*0.55));
  });

  $("#btnCopy").addEventListener("click", async (ev)=>{
    if(!pickedKind) return;
    const daily = getDaily(pickedKind);
    await copyText(daily.text);
    burstHearts(ev.clientX || (window.innerWidth/2), ev.clientY || (window.innerHeight*0.55));
  });

  $("#btnReset").addEventListener("click", (ev)=>{
    ev.preventDefault();
    // Reset today: allow re-pick + new compliment for that kind/day combination
    localStorage.removeItem(KEY);
    localStorage.removeItem(LUCKY);
    localStorage.removeItem(PICK);

    // UI reset
    hasFlipped = false;
    pickedKind = "";
    setStateHint("尚未翻牌");
    $("#btnReveal").disabled = true;
    $("#btnReveal").textContent = "收穫今天的讚美吧";
    $("#btnCopy").disabled = true;
    $("#tag").textContent = "#等你翻牌";
    $("#compliment").textContent = "（翻一張卡，我就把今天的讚美遞給你。）";
    $("#compliment").classList.remove("show");
    $("#luckyBox").style.display = "none";

    document.querySelectorAll(".flip").forEach(el => el.classList.remove("is-flipped"));
  });
</script>
</body>
</html>
