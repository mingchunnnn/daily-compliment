<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>每日讚美收穫所</title>
  <style>
    :root{
      --ink:#1f2430;
      --muted:#4b5563;

      --line:#ffffffa8;
      --shadow: 0 22px 60px rgba(10,16,28,.18);
      --shadow2: 0 14px 34px rgba(10,16,28,.14);
      --radius: 22px;

      --g1:#ffd6ea; /* pearl pink */
      --g2:#c7f0ff; /* sea blue */
      --g3:#cdbdff; /* lilac */
      --g4:#bfffe7; /* mint */
      --g5:#ffe9c7; /* champagne */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--ink);
      overflow-x:hidden;

      background:
        radial-gradient(900px 520px at 12% 8%, rgba(255,214,234,.92) 0%, rgba(255,214,234,0) 60%),
        radial-gradient(820px 520px at 88% 14%, rgba(199,240,255,.92) 0%, rgba(199,240,255,0) 60%),
        radial-gradient(900px 560px at 52% 92%, rgba(205,189,255,.85) 0%, rgba(205,189,255,0) 62%),
        radial-gradient(720px 520px at 70% 70%, rgba(191,255,231,.55) 0%, rgba(191,255,231,0) 70%),
        linear-gradient(135deg, #fff2f8 0%, #e9fbff 35%, #f5efff 70%, #fff6ea 100%);
    }

    .sheen{
      position:fixed; inset:-10vh -10vw;
      pointer-events:none;
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(255,214,234,.18),
          rgba(199,240,255,.18),
          rgba(205,189,255,.18),
          rgba(191,255,231,.18),
          rgba(255,233,199,.18),
          rgba(255,214,234,.18));
      filter: blur(22px);
      opacity:.7;
      animation: sheen 18s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    @keyframes sheen{
      0%{ transform: translate3d(-2%, -1%, 0) rotate(0deg) scale(1.05); }
      50%{ transform: translate3d(2%, 1%, 0) rotate(18deg) scale(1.1); }
      100%{ transform: translate3d(-2%, -1%, 0) rotate(0deg) scale(1.05); }
    }

    .sparkle{ position:fixed; inset:-20vh -10vw; pointer-events:none; opacity:.95; }
    .dot{
      position:absolute;
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 62%);
      opacity:.35;
      animation: floaty linear infinite;
    }
    .bubble{
      position:absolute;
      width:14px; height:14px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.55);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 65%);
      box-shadow: 0 12px 24px rgba(10,16,28,.08);
      opacity:.22;
      animation: bubbleUp linear infinite;
    }
    @keyframes floaty{
      from{ transform: translate3d(var(--x0), var(--y0), 0) scale(var(--s)); }
      to  { transform: translate3d(var(--x1), var(--y1), 0) scale(var(--s)); }
    }
    @keyframes bubbleUp{
      from{ transform: translate3d(var(--x0), var(--y0), 0) scale(var(--s)); opacity:.12; }
      20%{opacity:.26}
      to  { transform: translate3d(var(--x1), var(--y1), 0) scale(var(--s)); opacity:0; }
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px 16px calc(24px + env(safe-area-inset-bottom));
    }

    /* Wider on desktop */
    .shell{
      width:min(980px, 100%);
    }

    .phone{
      border-radius: 30px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.28));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
    }
    .phone::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(240px 160px at 18% 12%, rgba(255,214,234,.35), transparent 70%),
        radial-gradient(240px 160px at 82% 18%, rgba(199,240,255,.35), transparent 70%),
        radial-gradient(260px 200px at 60% 86%, rgba(205,189,255,.28), transparent 72%);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:relative;
      padding: 14px 12px 6px;
      display:flex; gap:10px;
      align-items:flex-start; justify-content:space-between;
      z-index:1;
    }
    .title{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    h1{ margin:0; font-size: 18px; letter-spacing:.5px; font-weight: 820; }
    .sub{ margin:0; font-size: 12px; color: var(--muted); line-height:1.25; }

    .topright{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
      border:1px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 22px rgba(10,16,28,.08);
      white-space:nowrap;
    }
    .iconbtn{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.85);
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
      box-shadow: 0 12px 22px rgba(10,16,28,.10);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease;
    }
    .iconbtn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.05); }
    .iconbtn span{ font-size: 16px; }

    .card{
      position:relative;
      margin-top: 12px;
      padding: 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.38));
      border: 1px solid rgba(255,255,255,.88);
      box-shadow: var(--shadow2);
      z-index:1;
    }

    /* Desktop: 2 columns */
    .grid{
      display:block;
    }
    @media (min-width: 860px){
      .grid{
        display:grid;
        grid-template-columns: 1.05fr .95fr;
        gap: 14px;
        align-items: start;
      }
      .card{ margin-top: 14px; }
    }

    .hint{
      margin: 2px 0 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint b{ color:#273149; }

    .deck{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 8px;
    }

    .flip{ perspective: 950px; height: 126px; }
    .flip button{
      width:100%; height:100%;
      padding:0; border:0;
      border-radius: 18px;
      background: transparent;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .flip-inner{
      position:relative;
      width:100%; height:100%;
      transform-style: preserve-3d;
      transition: transform 520ms cubic-bezier(.2,.8,.2,1);
      border-radius: 18px;
    }
    .flip.is-flipped .flip-inner{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      border-radius: 18px;
      backface-visibility:hidden;
      border: 1px solid rgba(255,255,255,.9);
      box-shadow: 0 14px 26px rgba(10,16,28,.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
      user-select:none;
    }

    .front{
      background:
        radial-gradient(140px 90px at 28% 20%, rgba(255,255,255,.95), rgba(255,255,255,0) 62%),
        linear-gradient(135deg, rgba(255,255,255,.9) 0%,
          rgba(255,214,234,.55) 30%,
          rgba(199,240,255,.55) 65%,
          rgba(205,189,255,.45) 100%);
      position:relative;
    }
    .front::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.45), transparent 55%);
      transform: rotate(18deg);
      opacity:.55;
      pointer-events:none;
    }
    .wrapfront{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .seal{
      width: 58px; height:58px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.62));
      border: 1px solid rgba(255,255,255,.92);
      display:flex; align-items:center; justify-content:center;
      font-size: 22px;
      box-shadow: 0 12px 22px rgba(10,16,28,.08);
    }
    .txt{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(39,49,73,.82);
      line-height: 1.2;
    }

    /* Back side: ONLY icon, no text */
    .back{
      transform: rotateY(180deg);
      background:
        radial-gradient(180px 110px at 70% 25%, rgba(255,255,255,.95), rgba(255,255,255,0) 64%),
        linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
    }
    .backIcon{
      width: 74px; height: 74px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.62));
      box-shadow: 0 14px 26px rgba(10,16,28,.10);
      display:flex; align-items:center; justify-content:center;
      font-size: 28px;
      color:#273149;
      position:relative;
      overflow:hidden;
    }
    .backIcon::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 58%);
      transform: rotate(12deg);
      opacity:.9;
    }

    .resultCard{
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.88);
      background: linear-gradient(180deg, rgba(255,255,255,.66), rgba(255,255,255,.34));
      box-shadow: 0 14px 34px rgba(10,16,28,.10);
      display:none;
    }
    .resultCard.show{ display:block; }

    .compliment{
      margin: 0;
      font-size: 16px;
      line-height: 1.65;
      letter-spacing: .3px;
      color: #21283a;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .ribbon{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(255,255,255,.60), rgba(255,255,255,.30));
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
    }
    .luck{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .luck .label{ font-size:12px; color: var(--muted); }
    .luck .value{
      font-size:14px; font-weight:840;
      letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:#273149;
    }
    .swatch{
      width: 46px; height: 46px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(10,16,28,.10);
      background: #b8a7b6;
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .swatch::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.55), transparent 55%);
      transform: rotate(18deg);
      opacity:.9;
    }

    .meta{
      margin-top: 10px;
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding: 13px 14px;
      font-size: 14px;
      font-weight: 780;
      letter-spacing: .4px;
      color: #23304a;
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 1px solid rgba(255,255,255,.92);
      box-shadow: 0 14px 30px rgba(10,16,28,.12);
      transition: transform .08s ease, filter .12s ease;
      flex: 1 1 160px;
      min-width: 150px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .footer{
      padding: 12px 4px 2px;
      display:flex; gap:10px;
      justify-content:space-between; align-items:center;
      color: var(--muted);
      font-size: 12px;
      position:relative;
      z-index:1;
    }
    .tiny{ opacity:.9; }
    a{ color: inherit; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,.85); }

    .heart{
      position:fixed;
      width: 12px; height: 12px;
      transform: rotate(45deg);
      background: rgba(255,255,255,.85);
      border-radius: 3px;
      pointer-events:none;
      filter: drop-shadow(0 8px 14px rgba(10,16,28,.18));
      animation: pop 900ms ease-out forwards;
      mix-blend-mode: screen;
    }
    .heart::before,.heart::after{
      content:"";
      position:absolute;
      width: 12px; height: 12px;
      background: inherit;
      border-radius: 999px;
      top:-6px; left:0;
    }
    .heart::after{ left:-6px; top:0; }
    @keyframes pop{
      0%{ opacity:0; transform: translate3d(0,0,0) rotate(45deg) scale(.6); }
      10%{ opacity:1; }
      100%{ opacity:0; transform: translate3d(var(--dx), var(--dy), 0) rotate(45deg) scale(1.35); }
    }

    @media (max-width: 360px){
      .deck{ gap:10px; }
      .flip{ height: 114px; }
      .btn{ min-width: 140px; }
    }
  </style>
</head>
<body>
  <div class="sheen"></div>
  <div class="sparkle" id="sparkle"></div>

  <div class="wrap">
    <div class="shell">
      <main class="phone" role="main">
        <header>
          <div class="title">
            <h1>每日讚美收穫所</h1>
            <p class="sub">翻一張浪漫卡，讚美與幸運色會立刻出現 ✧</p>
          </div>

          <div class="topright">
            <div class="pill" id="todayPill">今天</div>
            <button class="iconbtn" id="btnAudio" aria-label="氛圍音開關" title="氛圍音開關">
              <span id="audioIcon">♪</span>
            </button>
          </div>
        </header>

        <section class="card" aria-live="polite">
          <div class="grid">
            <!-- LEFT: cards -->
            <div>
              <div class="hint">
                <span>請翻一張卡：<b>愛意 / 光芒 / 安心</b></span>
                <span id="stateHint">尚未翻牌</span>
              </div>

              <div class="deck">
                <div class="flip" data-kind="愛意">
                  <button type="button" aria-label="翻牌：愛意">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">♡</div>
                          <div class="txt">點我翻開<br/>愛意卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">♡</div>
                      </div>
                    </div>
                  </button>
                </div>

                <div class="flip" data-kind="光芒">
                  <button type="button" aria-label="翻牌：光芒">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">✦</div>
                          <div class="txt">點我翻開<br/>光芒卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">✦</div>
                      </div>
                    </div>
                  </button>
                </div>

                <div class="flip" data-kind="安心">
                  <button type="button" aria-label="翻牌：安心">
                    <div class="flip-inner">
                      <div class="face front">
                        <div class="wrapfront">
                          <div class="seal">☁︎</div>
                          <div class="txt">點我翻開<br/>安心卡</div>
                        </div>
                      </div>
                      <div class="face back">
                        <div class="backIcon">☁︎</div>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- RIGHT: result -->
            <div class="resultCard" id="resultCard">
              <p class="compliment" id="compliment">（翻牌後出現。）</p>

              <div class="ribbon">
                <div class="luck">
                  <div class="label">今日浪漫幸運色</div>
                  <div class="value" id="luckyText">—</div>
                </div>
                <div class="swatch" id="swatch"></div>
              </div>

              <div class="meta">
                <span id="tag">#等你翻牌</span>
                <span id="streak">連續收穫：0 天</span>
              </div>

              <div class="actions">
                <button class="btn" id="btnCopy" disabled>複製（含幸運色）</button>
                <button class="btn" id="btnReset">重置今天</button>
              </div>
            </div>
          </div>
        </section>

        <div class="footer">
          <span class="tiny">提示：音效/氛圍音會在第一次互動後啟用。</span>
          <span class="tiny"><a href="#" id="btnAudioHint">如果沒聲音，點我一下</a></span>
        </div>
      </main>
    </div>
  </div>

<script>
  const $ = (s) => document.querySelector(s);

  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };
  const niceDate = () => {
    const d = new Date();
    return d.toLocaleDateString('zh-TW', { month:'long', day:'numeric', weekday:'short' });
  };
  const hash32 = (str) => {
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  };
  const pick = (arr, seed) => arr[ seed % arr.length ];

  // Particles
  (function buildParticles(){
    const root = document.getElementById('sparkle');
    const w = window.innerWidth, h = window.innerHeight;

    for(let i=0;i<22;i++){
      const dot = document.createElement('div');
      dot.className = 'dot';
      const size = 6 + Math.random()*14;
      dot.style.width = dot.style.height = size + 'px';
      dot.style.left = (Math.random()*110 - 5) + 'vw';
      dot.style.top  = (Math.random()*120 - 10) + 'vh';
      dot.style.opacity = (0.16 + Math.random()*0.24).toFixed(2);
      const s = 0.6 + Math.random()*1.6;
      dot.style.setProperty('--s', s.toFixed(2));
      dot.style.setProperty('--x0', (Math.random()*w) + 'px');
      dot.style.setProperty('--y0', (Math.random()*h) + 'px');
      dot.style.setProperty('--x1', (Math.random()*w) + 'px');
      dot.style.setProperty('--y1', (-140 - Math.random()*h) + 'px');
      dot.style.animationDuration = (18 + Math.random()*18).toFixed(1) + 's';
      dot.style.animationDelay = (-Math.random()*18).toFixed(1) + 's';
      root.appendChild(dot);
    }

    for(let i=0;i<18;i++){
      const b = document.createElement('div');
      b.className = 'bubble';
      const size = 10 + Math.random()*26;
      b.style.width = b.style.height = size + 'px';
      b.style.left = (Math.random()*110 - 5) + 'vw';
      b.style.top  = (60 + Math.random()*70) + 'vh';
      const s = 0.6 + Math.random()*1.5;
      b.style.setProperty('--s', s.toFixed(2));
      b.style.setProperty('--x0', (Math.random()*w) + 'px');
      b.style.setProperty('--y0', (h + 120 + Math.random()*200) + 'px');
      b.style.setProperty('--x1', (Math.random()*w) + 'px');
      b.style.setProperty('--y1', (-220 - Math.random()*h) + 'px');
      b.style.animationDuration = (16 + Math.random()*18).toFixed(1) + 's';
      b.style.animationDelay = (-Math.random()*16).toFixed(1) + 's';
      root.appendChild(b);
    }
  })();

  // Compliment engine
  const vocab = {
    vibe: ["乾淨的氣質","溫柔但有底氣的氣場","很耐看的光","不張揚的耀眼","安靜的自信","舒服的存在感"],
    eyes: ["眼神","笑容","語氣","步伐","表情","說話的節奏"],
    quality: ["細膩","真誠","有分寸","有想法","有同理心","很可靠","很有品味","很會照顧人但不委屈自己"],
    effort: ["你願意把事情做好","你在疲憊時仍不敷衍","你把自己慢慢照顧回來","你願意學、願意改、也願意原諒自己","你把小事做得很漂亮"],
    charm: ["可愛得很有個性","漂亮得不需要大聲","迷人得很有層次","溫柔得很有邊界","閃亮得剛剛好"],
    metaphor: [
      "像珍珠的光：不刺眼，但越看越覺得你很迷人。",
      "像海面上的月光：溫柔、清亮，讓人忍不住想靠近。",
      "像剛剛好的浪：輕輕推你向前，卻從不讓你窒息。",
      "像海風的擁抱：看似輕，卻能把煩躁慢慢吹走。",
      "像一首耐聽的歌：越聽越覺得你很有內容。"
    ],
    ending: [
      "所以今天也請你放心：你很值得被喜歡。",
      "我希望你把這句話收好，因為它是真的。",
      "你不用變成誰的版本，你就是很好看的那種人。",
      "世界很吵，但你是那種能讓人靜下來的存在。",
      "你已經做得很棒了，而且你還會更好。"
    ],
    tag: ["#氣質派讚美","#內在發光","#外在也很可以","#溫柔但堅定","#今天的你很迷人","#你值得被好好看見"]
  };

  const fullCompliments = [
    "你有一種很稀有的能力：把複雜的事情用溫柔講清楚，還不會讓人覺得被冒犯。",
    "你不是那種靠用力討好才可愛的人；你可愛得很自然，像呼吸一樣。",
    "你最迷人的地方不是外表的某一個點，而是你整個人散發的「好好生活」感。",
    "你有一種乾淨的漂亮：不需要很多裝飾，就已經很耐看、很舒服。",
    "你在意細節的方式很漂亮，不是控制，是把每件事都做得有質感。",
    "你看似溫柔，但你其實很有骨氣；這種反差特別讓人尊敬。",
    "你讓人覺得安心，不是因為你完美，而是你真誠、也願意好好面對。",
    "你把界線畫得剛剛好：既不冷漠，也不委屈自己，這真的很成熟。",
    "你有一種不急著證明什麼的自信，那種從容比任何標籤都更漂亮。",
    "你不是在「撐住」，你是在「往前走」——而且走得比你以為的更好看。"
  ];

  const toneLine = {
    "愛意": [
      "你不需要用力，就已經很討喜。",
      "你值得被溫柔對待，而且不需要先表現很好。",
      "你的可愛很自然，像呼吸一樣。"
    ],
    "光芒": [
      "你一認真起來，整個人都有光。",
      "你不是一下就看懂的漂亮，你是越看越驚喜的那種。",
      "你有把平凡變質感的能力，超難得。"
    ],
    "安心": [
      "你讓人放鬆，像終於能把肩膀放下來那樣。",
      "你說話的溫度剛剛好，能被接住。",
      "你身上有種「會好起來」的氣息。"
    ]
  };

  const templates = [
    (r)=>`你今天的${r.eyes}很有故事感，不需要解釋太多，就讓人想靠近一點、再靠近一點。${r.ending}`,
    (r)=>`你身上那種${r.vibe}很加分：不是高調的漂亮，而是會讓人記住的那種。${r.ending}`,
    (r)=>`我很喜歡你處理事情的方式——${r.quality}又不失溫度，這真的不是每個人都有。${r.ending}`,
    (r)=>`你知道嗎？${r.effort}的樣子特別好看，因為那代表你很認真地在愛自己的人生。${r.ending}`,
    (r)=>`你給人的感覺是${r.charm}，而且越相處越明顯。${r.metaphor} ${r.ending}`,
    (r)=>`如果把你放進一幅海的畫裡，你一定是那個最耐看的光點：柔和、清亮，卻很有力量。${r.ending}`
  ];

  function buildCompliment(seed, kind){
    const r = {
      vibe: pick(vocab.vibe, seed+11),
      eyes: pick(vocab.eyes, seed+23),
      quality: pick(vocab.quality, seed+37),
      effort: pick(vocab.effort, seed+41),
      charm: pick(vocab.charm, seed+53),
      metaphor: pick(vocab.metaphor, seed+67),
      ending: pick(vocab.ending, seed+71)
    };
    const useFull = (seed % 10) < 3;
    const base = useFull ? fullCompliments[seed % fullCompliments.length] : templates[seed % templates.length](r);
    const tone = pick(toneLine[kind] || toneLine["愛意"], seed+97);
    return `${tone}\n\n${base}`;
  }
  function pickTag(seed){ return pick(vocab.tag, seed+101); }

  const mermaidColors = [
    {name:"珍珠粉", hex:"#ffd6ea"},
    {name:"海月藍", hex:"#c7f0ff"},
    {name:"人魚紫", hex:"#cdbdff"},
    {name:"泡泡薄荷", hex:"#bfffe7"},
    {name:"香檳珍珠", hex:"#ffe9c7"},
    {name:"霧霓虹粉", hex:"#ffb9d6"},
    {name:"珊瑚奶油", hex:"#ffd0c8"},
    {name:"海鹽薰衣草", hex:"#bfb7ff"},
    {name:"柔光青藍", hex:"#b8e6ff"},
    {name:"貝殼米", hex:"#f7e7d3"}
  ];
  function getLuckyColor(){
    const day = todayISO();
    const seed = hash32("lucky::" + day);
    return mermaidColors[seed % mermaidColors.length];
  }

  // Daily lock
  const KEY = "daily-compliment-mermaid-v2";
  const PICK = "daily-pick-kind-v3";
  const STREAK = "daily-streak-v1";
  const LASTDAY = "daily-lastday-v1";

  function getDaily(kind){
    const day = todayISO();
    const saved = JSON.parse(localStorage.getItem(KEY) || "null");
    if(saved && saved.day === day && saved.kind === kind && saved.text){
      return saved;
    }
    const seed = hash32("compliment::" + day + "::" + kind);
    const text = buildCompliment(seed, kind);
    const tag = pickTag(seed);
    const payload = { day, kind, seed, text, tag };
    localStorage.setItem(KEY, JSON.stringify(payload));
    return payload;
  }

  function updateStreak(){
    const day = todayISO();
    const last = localStorage.getItem(LASTDAY);
    let streak = parseInt(localStorage.getItem(STREAK) || "0", 10);

    if(last === day){
      // already counted
    } else {
      if(last){
        const dLast = new Date(last + "T00:00:00");
        const dToday = new Date(day  + "T00:00:00");
        const diff = Math.round((dToday - dLast) / (24*3600*1000));
        streak = (diff === 1) ? (streak + 1) : 1;
      } else {
        streak = 1;
      }
      localStorage.setItem(STREAK, String(streak));
      localStorage.setItem(LASTDAY, day);
    }
    $("#streak").textContent = `連續收穫：${streak} 天`;
  }

  function burstHearts(x,y){
    const n = 12;
    for(let i=0;i<n;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      h.style.left = x + 'px';
      h.style.top  = y + 'px';
      h.style.setProperty('--dx', (Math.random()*170 - 85).toFixed(1) + 'px');
      h.style.setProperty('--dy', (-90 - Math.random()*170).toFixed(1) + 'px');
      h.style.opacity = (0.5 + Math.random()*0.5).toFixed(2);
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 950);
    }
  }

  // ===== WebAudio: Mermaid vibe =====
  let audioCtx = null;
  let ambientOn = false;
  let ambientNodes = null;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function now(){ return audioCtx.currentTime; }

  function makeReverbLikeGain(){
    // lightweight "space" by using a feedback delay + filter (cheap reverb-ish)
    const input = audioCtx.createGain();
    const delay = audioCtx.createDelay(1.2);
    delay.delayTime.value = 0.22;
    const feedback = audioCtx.createGain();
    feedback.gain.value = 0.35;
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 1800;

    input.connect(delay);
    delay.connect(lp);
    lp.connect(feedback);
    feedback.connect(delay);

    const wet = audioCtx.createGain();
    wet.gain.value = 0.35;
    lp.connect(wet);

    const out = audioCtx.createGain();
    out.gain.value = 0.9;

    input.connect(out); // dry
    wet.connect(out);   // wet
    return { input, out };
  }

  function playChime(type="pearl"){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();

    const t0 = now();
    const master = audioCtx.createGain();
    master.gain.setValueAtTime(0.0001, t0);
    master.gain.exponentialRampToValueAtTime(0.35, t0 + 0.02);
    master.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.4);

    const rev = makeReverbLikeGain();
    master.connect(rev.input);
    rev.out.connect(audioCtx.destination);

    // Crystal bell partials
    const freqs =
      type === "love"  ? [523.25, 659.25, 783.99] :
      type === "shine" ? [587.33, 740.00, 880.00] :
      type === "calm"  ? [493.88, 622.25, 740.00] :
                         [554.37, 698.46, 830.61];

    freqs.forEach((f, i)=>{
      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.setValueAtTime(f, t0);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.22/(i+1), t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.2);

      osc.connect(g);
      g.connect(master);

      osc.start(t0 + i*0.012);
      osc.stop(t0 + 1.25);
    });

    // Bubble pops (short filtered noise)
    for(let i=0;i<4;i++){
      const tt = t0 + 0.06 + i*0.09;
      const bufferSize = Math.floor(audioCtx.sampleRate * 0.08);
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let j=0;j<bufferSize;j++){
        data[j] = (Math.random()*2 - 1) * (1 - j/bufferSize);
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;

      const bp = audioCtx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(900 + Math.random()*700, tt);
      bp.Q.value = 6;

      const ng = audioCtx.createGain();
      ng.gain.setValueAtTime(0.0001, tt);
      ng.gain.exponentialRampToValueAtTime(0.10, tt + 0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, tt + 0.09);

      noise.connect(bp);
      bp.connect(ng);
      ng.connect(master);

      noise.start(tt);
      noise.stop(tt + 0.08);
    }
  }

  function startAmbient(){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();
    if(ambientOn) return;

    // Soft ocean pad: filtered noise + slow LFO + subtle shimmer tones
    const out = audioCtx.createGain();
    out.gain.value = 0.12;

    const rev = makeReverbLikeGain();
    out.connect(rev.input);
    rev.out.connect(audioCtx.destination);

    // Noise
    const bufferSize = audioCtx.sampleRate * 2;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++){
      data[i] = (Math.random()*2 - 1) * 0.25;
    }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    noise.loop = true;

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 450; // ocean hush

    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.value = 60;

    const nGain = audioCtx.createGain();
    nGain.gain.value = 0.55;

    noise.connect(lp);
    lp.connect(hp);
    hp.connect(nGain);
    nGain.connect(out);

    // Slow LFO to "breathe"
    const lfo = audioCtx.createOscillator();
    lfo.type = "sine";
    lfo.frequency.value = 0.06;

    const lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 0.18;
    lfo.connect(lfoGain);
    lfoGain.connect(nGain.gain);

    // Shimmer (very soft)
    const shimmer = audioCtx.createOscillator();
    shimmer.type = "sine";
    shimmer.frequency.value = 220;

    const shimmer2 = audioCtx.createOscillator();
    shimmer2.type = "sine";
    shimmer2.frequency.value = 277.18;

    const sGain = audioCtx.createGain();
    sGain.gain.value = 0.0001;

    const t0 = now();
    // fade in
    sGain.gain.setValueAtTime(0.0001, t0);
    sGain.gain.exponentialRampToValueAtTime(0.045, t0 + 1.2);

    shimmer.connect(sGain);
    shimmer2.connect(sGain);
    sGain.connect(out);

    noise.start();
    lfo.start();
    shimmer.start();
    shimmer2.start();

    ambientNodes = { out, noise, lfo, shimmer, shimmer2, sGain, nGain };
    ambientOn = true;
    $("#audioIcon").textContent = "♫";
  }

  function stopAmbient(){
    if(!audioCtx || !ambientOn || !ambientNodes) return;

    const t0 = now();
    // graceful fade
    ambientNodes.out.gain.setTargetAtTime(0.0001, t0, 0.12);

    setTimeout(()=>{
      try{
        ambientNodes.noise.stop();
        ambientNodes.lfo.stop();
        ambientNodes.shimmer.stop();
        ambientNodes.shimmer2.stop();
      }catch(e){}
      ambientNodes = null;
      ambientOn = false;
      $("#audioIcon").textContent = "♪";
    }, 650);
  }

  function toggleAmbient(){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();
    if(ambientOn) stopAmbient();
    else startAmbient();
  }

  // UI audio buttons
  $("#btnAudio").addEventListener("click", ()=> toggleAmbient());
  $("#btnAudioHint").addEventListener("click", (ev)=>{ ev.preventDefault(); toggleAmbient(); });

  // Init
  $("#todayPill").textContent = niceDate();
  $("#streak").textContent = `連續收穫：${parseInt(localStorage.getItem(STREAK)||"0",10)} 天`;

  let hasFlipped = false;

  function showResult(kind, clickX, clickY){
    const daily = getDaily(kind);
    const lucky = getLuckyColor();

    $("#compliment").textContent = daily.text;
    $("#tag").textContent = daily.tag;

    $("#luckyText").textContent = `${lucky.name}（${lucky.hex}）`;
    $("#swatch").style.background = lucky.hex;

    $("#resultCard").classList.add("show");
    $("#btnCopy").disabled = false;

    $("#stateHint").textContent = `你翻到「${kind}」— 已收穫今天的讚美 ✧`;
    updateStreak();
    burstHearts(clickX || (window.innerWidth/2), clickY || (window.innerHeight*0.48));

    // sound
    const tone = (kind === "愛意") ? "love" : (kind === "光芒") ? "shine" : "calm";
    playChime(tone);
    // optional: start ambient gently after first interaction
    if(!ambientOn) startAmbient();
  }

  // Flip logic
  document.querySelectorAll(".flip").forEach((el)=>{
    el.addEventListener("click", (ev)=>{
      if(hasFlipped) return;
      hasFlipped = true;

      const kind = el.getAttribute("data-kind");
      localStorage.setItem(PICK, kind);

      el.classList.add("is-flipped");
      setTimeout(()=>{
        showResult(kind, ev.clientX, ev.clientY);
      }, 320);
    });
  });

  // Copy
  $("#btnCopy").addEventListener("click", async ()=>{
    const kind = localStorage.getItem(PICK);
    if(!kind) return;
    const daily = getDaily(kind);
    const text = `${daily.text}\n\n${$("#luckyText").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      $("#tag").textContent = "#已複製（含幸運色）";
      playChime("pearl");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      $("#tag").textContent = "#已複製（含幸運色）";
      playChime("pearl");
    }
  });

  // Reset today
  $("#btnReset").addEventListener("click", ()=>{
    localStorage.removeItem(KEY);
    localStorage.removeItem(PICK);
    hasFlipped = false;

    $("#stateHint").textContent = "尚未翻牌";
    $("#resultCard").classList.remove("show");
    $("#btnCopy").disabled = true;
    $("#tag").textContent = "#等你翻牌";
    $("#compliment").textContent = "（翻牌後出現。）";

    document.querySelectorAll(".flip").forEach(el => el.classList.remove("is-flipped"));
    playChime("pearl");
  });
</script>
</body>
</html>
